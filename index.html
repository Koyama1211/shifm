<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#1e8f6e" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <title>個人バイトシフト管理</title>
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="bg-shape bg-shape-a"></div>
    <div class="bg-shape bg-shape-b"></div>

    <section id="authScreen" class="auth-screen">
      <div class="auth-card">
        <h2 id="authTitle">ログイン</h2>
        <p id="authDescription" class="section-note">利用前に認証してください。</p>
        <form id="authForm">
          <div class="field-row">
            <label for="authUserId">メールアドレス</label>
            <input id="authUserId" name="authUserId" type="email" autocomplete="username" required />
          </div>
          <div class="field-row">
            <label for="authPassword">パスワード</label>
            <input id="authPassword" name="authPassword" type="password" autocomplete="current-password" required />
          </div>
          <div id="authConfirmRow" class="field-row">
            <label for="authPasswordConfirm">パスワード(確認)</label>
            <input
              id="authPasswordConfirm"
              name="authPasswordConfirm"
              type="password"
              autocomplete="new-password"
              required
            />
          </div>
          <p id="authStatus" class="section-note"></p>
          <div class="actions">
            <button id="authSubmit" type="submit" class="primary">ログイン</button>
            <button id="authToggleMode" type="button">新規登録に切替</button>
          </div>
        </form>
      </div>
    </section>

    <main id="appMain" class="container" hidden>
      <header class="app-header">
        <div class="app-header-row">
          <div>
            <h1>個人バイトシフト管理</h1>
            <p id="currentUserLabel" class="section-note">ログイン中: -</p>
          </div>
          <button id="logoutButton" type="button">ログアウト</button>
        </div>
        <p>カレンダーで管理しつつ、給与を自動計算</p>
      </header>

      <nav class="view-nav" aria-label="機能ナビゲーション" role="tablist">
        <button class="view-tab is-active" type="button" data-view-target="shift" role="tab" aria-selected="true" aria-controls="view-shift">シフト</button>
        <button class="view-tab" type="button" data-view-target="summary" role="tab" aria-selected="false" aria-controls="view-summary">月次サマリー</button>
        <button class="view-tab" type="button" data-view-target="settings" role="tab" aria-selected="false" aria-controls="view-settings">設定</button>
        <button class="view-tab" type="button" data-view-target="sync" role="tab" aria-selected="false" aria-controls="view-sync">同期</button>
      </nav>

      <section id="view-shift" class="view-section is-active" data-view="shift" role="tabpanel" aria-labelledby="tab-shift">
        <div class="shift-mobile-switch" aria-label="シフト画面モード切替">
          <button id="showShiftListPane" type="button" class="is-active">表示</button>
          <button id="showShiftFormPane" type="button">入力</button>
        </div>
        <div id="shiftLayout" class="view-layout shift-layout mobile-pane-list">
          <section class="panel calendar-panel">
            <div class="calendar-head">
              <button id="prevMonth" type="button" aria-label="前の月">◀</button>
              <h2 id="monthLabel"></h2>
              <div class="calendar-head-actions">
                <button id="jumpToday" type="button" aria-label="今日へ移動">今日</button>
                <button id="nextMonth" type="button" aria-label="次の月">▶</button>
              </div>
            </div>
            <div id="calendarGrid" class="calendar-grid" aria-live="polite"></div>
            <div class="day-list-wrap under-calendar">
              <div class="day-list-head">
                <h4>選択日のシフト</h4>
                <p id="selectedDayShiftsLabel" class="section-note">日付を選択してください</p>
              </div>
              <div class="actions inline-actions">
                <button id="jumpToForm" type="button">この日の入力へ移動</button>
              </div>
              <ul id="dayShiftList" class="day-shift-list"></ul>
            </div>
          </section>

          <section id="shiftFormPanel" class="panel form-panel">
            <h3 id="selectedDateLabel">日付を選択してください</h3>
            <p id="editingStatus" class="editing-status">新規シフトを入力中</p>
            <form id="shiftForm">
              <input id="editingShiftId" name="editingShiftId" type="hidden" />
              <h4 class="form-section-title">基本入力</h4>
              <p class="section-note"><span class="required-mark">*</span> は必須項目です。</p>
              <div class="field-row">
                <label for="workplaceMaster">勤務先マスタ</label>
                <select id="workplaceMaster" name="workplaceMaster">
                  <option value="">未選択</option>
                </select>
                <p class="section-note">選択時に勤務先・時給・交通費へ自動反映します。</p>
              </div>
              <div class="field-row">
                <label for="workplace">勤務先 <span class="required-mark">*</span></label>
                <input
                  id="workplace"
                  name="workplace"
                  type="text"
                  placeholder="例: カフェA"
                  list="workplaceSuggestions"
                  required
                />
                <datalist id="workplaceSuggestions"></datalist>
                <p id="timeeWorkplaceNote" class="section-note" hidden>タイミー選択時は案件先の勤務先名を入力してください。</p>
              </div>
              <div class="collapsible-block">
                <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="patternBlock">
                  勤務パターン（任意）
                  <span class="collapsible-arrow" aria-hidden="true">▼</span>
                </button>
                <div id="patternBlock" class="collapsible-content" hidden>
                  <div class="field-row split">
                    <div>
                      <label for="shiftLine">ライン</label>
                      <select id="shiftLine" name="shiftLine">
                        <option value="">未選択</option>
                      </select>
                    </div>
                    <div>
                      <label for="shiftPattern">シフトパターン</label>
                      <select id="shiftPattern" name="shiftPattern">
                        <option value="">未選択</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="field-row split">
                <div>
                  <label for="startTime">開始 <span class="required-mark">*</span></label>
                  <input id="startTime" name="startTime" type="time" required />
                </div>
                <div>
                  <label for="endTime">終了 <span class="required-mark">*</span></label>
                  <input id="endTime" name="endTime" type="time" required />
                </div>
              </div>
              <p class="section-note">時刻欄をタップすると端末標準の時刻ピッカーが開きます。</p>
              <div class="field-row split">
                <div>
                  <label for="breakMinutes">休憩(分・例: 45)</label>
                  <input id="breakMinutes" name="breakMinutes" type="number" min="0" step="1" value="0" />
                </div>
                <div>
                  <label for="shiftStatusAutoLabel">勤務ステータス（自動）</label>
                  <input id="shiftStatusAutoLabel" name="shiftStatusAutoLabel" type="text" value="予定" readonly />
                  <input id="shiftStatus" name="shiftStatus" type="hidden" value="planned" />
                </div>
              </div>
              <div id="timeeCompensationFields" class="field-row split" hidden>
                <div id="hourlyRateGroup">
                  <label for="hourlyRate">時給(円) <span class="required-mark">*</span></label>
                  <input id="hourlyRate" name="hourlyRate" type="number" min="0" step="1" />
                </div>
                <div id="transportGroup">
                  <label for="transport">交通費(円)</label>
                  <input id="transport" name="transport" type="number" min="0" step="1" value="0" />
                </div>
              </div>
              <div class="field-row">
                <label for="memo">メモ</label>
                <input id="memo" name="memo" type="text" placeholder="例: まかないあり" />
              </div>
              <input id="timeeEnabled" name="timeeEnabled" type="checkbox" hidden />
              <div class="compact-block">
                <p class="section-note">保存前見込み</p>
                <p class="editing-status">
                  労働時間: <strong id="previewWorkedHours">-</strong> / 支給見込み: <strong id="previewGrossPay">-</strong>
                </p>
              </div>
              <div class="actions">
                <button type="submit" class="primary">保存</button>
                <button id="newShift" type="button">新規入力</button>
              </div>
            </form>
            <div class="collapsible-block">
              <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="auxBlock">
                補助機能
                <span class="collapsible-arrow" aria-hidden="true">▼</span>
              </button>
              <div id="auxBlock" class="collapsible-content" hidden>
              <div class="actions advanced-actions">
                <button id="saveAsMaster" type="button">勤務先マスタに保存</button>
                <button id="addGoogleCalendar" type="button">Google Calendar登録</button>
                <button id="addDayGoogleCalendar" type="button">当日分をGoogle登録</button>
                <button id="deleteShift" type="button" class="danger">選択シフトを削除</button>
              </div>
              <div class="advanced-divider"></div>
              <div id="bulkShiftForm" class="sub-form">
                <h4 class="form-section-title">定型シフト一括登録（週次）</h4>
                <div class="field-row split">
                  <div>
                    <label for="bulkWorkplaceMaster">勤務先マスタ</label>
                    <select id="bulkWorkplaceMaster" name="bulkWorkplaceMaster">
                      <option value="">未選択</option>
                    </select>
                  </div>
                  <div>
                    <label for="bulkWorkplace">勤務先</label>
                    <input id="bulkWorkplace" name="bulkWorkplace" type="text" placeholder="例: カフェA" />
                  </div>
                </div>

                <div class="field-row split">
                  <div>
                    <label for="bulkStartTime">開始</label>
                    <input id="bulkStartTime" name="bulkStartTime" type="time" />
                  </div>
                  <div>
                    <label for="bulkEndTime">終了</label>
                    <input id="bulkEndTime" name="bulkEndTime" type="time" />
                  </div>
                </div>

                <div class="field-row split">
                  <div>
                    <label for="bulkBreakMinutes">休憩(分)</label>
                    <input id="bulkBreakMinutes" name="bulkBreakMinutes" type="number" min="0" step="1" value="0" />
                  </div>
                  <div>
                    <label for="bulkHourlyRate">時給(円)</label>
                    <input id="bulkHourlyRate" name="bulkHourlyRate" type="number" min="0" step="1" />
                  </div>
                </div>

                <div class="field-row">
                  <label for="bulkTransport">交通費(円)</label>
                  <input id="bulkTransport" name="bulkTransport" type="number" min="0" step="1" value="0" />
                </div>

                <div class="field-row">
                  <label>曜日選択</label>
                  <div class="weekday-checks">
                    <label><input type="checkbox" name="bulkWeekday" value="0" />日</label>
                    <label><input type="checkbox" name="bulkWeekday" value="1" checked />月</label>
                    <label><input type="checkbox" name="bulkWeekday" value="2" />火</label>
                    <label><input type="checkbox" name="bulkWeekday" value="3" checked />水</label>
                    <label><input type="checkbox" name="bulkWeekday" value="4" />木</label>
                    <label><input type="checkbox" name="bulkWeekday" value="5" checked />金</label>
                    <label><input type="checkbox" name="bulkWeekday" value="6" />土</label>
                  </div>
                </div>

                <div class="field-row split">
                  <div>
                    <label for="bulkStartDate">開始日</label>
                    <input id="bulkStartDate" name="bulkStartDate" type="date" />
                  </div>
                  <div>
                    <label for="bulkEndDate">終了日</label>
                    <input id="bulkEndDate" name="bulkEndDate" type="date" />
                  </div>
                </div>

                <div class="field-row">
                  <label>
                    <input id="bulkSkipExisting" name="bulkSkipExisting" type="checkbox" checked />
                    同一シフト（勤務先・開始終了時刻）が既にある日は追加しない
                  </label>
                </div>

                <div class="actions">
                  <button id="applyBulkShift" type="button" class="primary">一括登録</button>
                </div>
                <p id="bulkShiftStatus" class="section-note"></p>
              </div>
            </div>
          </section>
        </div>
      </section>

      <section id="view-summary" class="view-section" data-view="summary" role="tabpanel" aria-labelledby="tab-summary" aria-hidden="true">
        <section class="panel summary-panel">
          <div class="summary-head">
            <div>
              <h3>月次サマリー</h3>
              <p id="summaryMonthLabel" class="section-note"></p>
            </div>
            <div class="summary-controls">
              <button id="summaryPrevMonth" type="button" aria-label="サマリー前月" class="mini-btn">◄</button>
              <button id="summaryNextMonth" type="button" aria-label="サマリー翌月" class="mini-btn">►</button>
              <button id="exportCsv" type="button">CSV出力</button>
              <button id="bulkExportGcal" type="button" class="gcal-btn" aria-label="Googleカレンダー一括登録">📅 Googleカレンダー一括登録</button>
            </div>
          </div>
          <div class="field-row summary-filter-row">
            <label for="summaryMasterFilter">表示対象の勤務先</label>
            <select id="summaryMasterFilter" name="summaryMasterFilter">
              <option value="all">全勤務先</option>
            </select>
          </div>
          <div class="collapsible-block">
            <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="payrollBlock">
              給与実績入力（入力した勤務先は自動で支払済みに反映）
              <span class="collapsible-arrow" aria-hidden="true">▼</span>
            </button>
            <div id="payrollBlock" class="collapsible-content" hidden>
            <form id="payrollForm">
              <div class="field-row split">
                <div>
                  <label for="payrollMonth">対象月</label>
                  <input id="payrollMonth" name="payrollMonth" type="month" required />
                </div>
                <div>
                  <label for="payrollWorkplaceMaster">勤務先マスタ</label>
                  <select id="payrollWorkplaceMaster" name="payrollWorkplaceMaster" required>
                    <option value="">勤務先を選択</option>
                  </select>
                </div>
              </div>
              <div class="field-row split">
                <div>
                  <label for="payrollAmount">支払実績額(円)</label>
                  <input id="payrollAmount" name="payrollAmount" type="number" min="0" step="1" required />
                </div>
                <div>
                  <label for="payrollPaidAt">支払日</label>
                  <input id="payrollPaidAt" name="payrollPaidAt" type="date" />
                </div>
              </div>
              <div class="actions">
                <button type="submit" class="primary">給与実績を保存</button>
              </div>
            </form>
            <ul id="payrollList" class="pattern-list"></ul>
            </div>
          </div>
          <div class="cards">
            <article class="card">
              <p>勤務日数</p>
              <strong id="totalDays">0 日</strong>
            </article>
            <article class="card">
              <p>総労働時間</p>
              <strong id="totalHours">0.0 時間</strong>
            </article>
            <article class="card">
              <p>支給見込み(総額)</p>
              <strong id="grossPay">0 円</strong>
            </article>
            <article class="card">
              <p>手取り見込み</p>
              <strong id="netPay">0 円</strong>
            </article>
          </div>
          <div class="list-wrap">
            <table>
              <thead>
                <tr>
                  <th>日付</th>
                  <th>勤務先</th>
                  <th>勤務時間</th>
                  <th>状態</th>
                  <th>支給額</th>
                </tr>
              </thead>
              <tbody id="monthlyRows"></tbody>
            </table>
          </div>
          <div class="list-wrap">
            <table>
              <thead>
                <tr>
                  <th>勤務先</th>
                  <th>勤務日数</th>
                  <th>労働時間</th>
                  <th>支給総額</th>
                </tr>
              </thead>
              <tbody id="workplaceSummaryRows"></tbody>
            </table>
          </div>
        </section>
      </section>

      <section id="view-settings" class="view-section" data-view="settings" role="tabpanel" aria-labelledby="tab-settings" aria-hidden="true">
        <div class="view-layout settings-layout">
          <section class="panel settings-panel">
            <h3>給与設定</h3>
            <p class="section-note">日々の計算ルールを管理します。</p>
              <form id="settingsForm">
              <div class="field-row split">
                <div>
                  <label for="defaultHourlyRate">デフォルト時給(円)</label>
                  <input id="defaultHourlyRate" name="defaultHourlyRate" type="number" min="0" step="1" />
                </div>
                <div>
                  <label for="overtimeThreshold">残業開始(時間/日)</label>
                  <input id="overtimeThreshold" name="overtimeThreshold" type="number" min="0" step="0.5" />
                </div>
              </div>
              <div class="field-row split">
                <div>
                  <label for="overtimeMultiplier">残業倍率</label>
                  <input id="overtimeMultiplier" name="overtimeMultiplier" type="number" min="1" step="0.05" />
                </div>
                <div>
                  <label for="taxRate">控除率(%)</label>
                  <input id="taxRate" name="taxRate" type="number" min="0" max="100" step="0.1" />
                </div>
              </div>
              <div class="actions">
                <button type="submit" class="primary">設定を保存</button>
              </div>
            </form>
          </section>

          <section class="panel master-panel">
            <h3>勤務先マスタ管理</h3>
              <form id="masterForm">
                <input id="masterId" name="masterId" type="hidden" />
                <div class="field-row">
                  <label for="masterName">勤務先名</label>
                  <input id="masterName" name="masterName" type="text" placeholder="例: カフェA" required />
                </div>
                <div class="field-row split">
                  <div>
                    <label for="masterOvertimeThreshold">残業開始(時間/日)</label>
                    <input id="masterOvertimeThreshold" name="masterOvertimeThreshold" type="number" min="0" step="0.5" />
                  </div>
                  <div>
                    <label for="masterOvertimeMultiplier">残業倍率</label>
                    <input id="masterOvertimeMultiplier" name="masterOvertimeMultiplier" type="number" min="1" step="0.05" />
                  </div>
                </div>
                <div class="field-row">
                  <label for="masterTaxRate">控除率(%)</label>
                  <input id="masterTaxRate" name="masterTaxRate" type="number" min="0" max="100" step="0.1" />
                </div>
                <div class="actions">
                  <button type="submit" class="primary">マスタ保存</button>
                  <button id="masterNew" type="button">新規</button>
                  <button id="masterDelete" type="button" class="danger">削除</button>
                </div>
                <div class="collapsible-block">
                  <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="masterRateBlock">
                    時給・交通費の期間管理
                    <span class="collapsible-arrow" aria-hidden="true">▼</span>
                  </button>
                  <div id="masterRateBlock" class="collapsible-content" hidden>
                  <p class="section-note">「適用開始日」ごとに給与条件を保存します。日次入力では自動反映されます。</p>
                  <input id="masterRateId" name="masterRateId" type="hidden" />
                  <div class="field-row split">
                    <div>
                      <label for="masterRateEffectiveFrom">適用開始日</label>
                      <input id="masterRateEffectiveFrom" name="masterRateEffectiveFrom" type="date" />
                    </div>
                    <div>
                      <label for="masterRateHourlyRate">時給(円)</label>
                      <input id="masterRateHourlyRate" name="masterRateHourlyRate" type="number" min="0" step="1" />
                    </div>
                  </div>
                  <div class="field-row">
                    <label for="masterRateTransport">交通費(円)</label>
                    <input id="masterRateTransport" name="masterRateTransport" type="number" min="0" step="1" value="0" />
                  </div>
                  <div class="actions">
                    <button id="masterRateSave" type="button">履歴を保存</button>
                    <button id="masterRateNew" type="button">新規履歴</button>
                    <button id="masterRateDelete" type="button" class="danger">履歴を削除</button>
                  </div>
                  <ul id="masterRateList" class="pattern-list"></ul>
                  </div>
                </div>
                <div class="collapsible-block">
                  <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="patternSettingBlock">
                    ライン・シフトパターン設定
                    <span class="collapsible-arrow" aria-hidden="true">▼</span>
                  </button>
                  <div id="patternSettingBlock" class="collapsible-content" hidden>
                  <input id="patternId" name="patternId" type="hidden" />
                  <div class="field-row split">
                    <div>
                      <label for="patternLineName">ライン名</label>
                      <input id="patternLineName" name="patternLineName" type="text" placeholder="例: レジ" />
                    </div>
                    <div>
                      <label for="patternName">パターン名</label>
                      <input id="patternName" name="patternName" type="text" placeholder="例: 早番A" />
                    </div>
                  </div>
                  <div class="field-row split">
                    <div>
                      <label for="patternStartTime">開始</label>
                      <input id="patternStartTime" name="patternStartTime" type="time" />
                    </div>
                    <div>
                      <label for="patternEndTime">終了</label>
                      <input id="patternEndTime" name="patternEndTime" type="time" />
                    </div>
                  </div>
                  <div class="field-row">
                    <label for="patternBreakMinutes">休憩(分)</label>
                    <input id="patternBreakMinutes" name="patternBreakMinutes" type="number" min="0" step="1" value="0" />
                  </div>
                  <div class="actions">
                    <button id="patternSave" type="button">パターン保存</button>
                    <button id="patternNew" type="button">新規</button>
                    <button id="patternDelete" type="button" class="danger">削除</button>
                  </div>
                  <ul id="patternList" class="pattern-list"></ul>
                  </div>
                </div>
                <ul id="masterList" class="master-list"></ul>
              </form>
          </section>
        </div>
      </section>

      <section id="view-sync" class="view-section" data-view="sync" role="tabpanel" aria-labelledby="tab-sync" aria-hidden="true">
        <section class="panel sync-panel">
          <h3>端末同期 (Supabase・自動)</h3>
          <p class="section-note">同じアカウントでログインすれば、保存内容は自動でクラウド同期されます。</p>
          <div class="actions">
            <button id="pullCloudMerge" type="button">今すぐクラウド再取得</button>
          </div>
          <p id="syncStatus">自動同期を準備中...</p>
          <div class="collapsible-block">
            <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="backupBlock">
              バックアップ（低頻度）
              <span class="collapsible-arrow" aria-hidden="true">▼</span>
            </button>
            <div id="backupBlock" class="collapsible-content" hidden>
              <div class="actions advanced-actions">
                <button id="exportBackup" type="button">バックアップ書き出し</button>
                <button id="importBackup" type="button">バックアップ読み込み</button>
              </div>
              <input id="backupFileInput" type="file" accept=".json,application/json" hidden />
            </div>
          </div>
        </section>
      </section>
    </main>

    <!-- Googleカレンダー一括登録モーダル -->
    <div id="gcalModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="gcalModalTitle" hidden>
      <div class="modal-dialog">
        <div class="modal-header">
          <h3 id="gcalModalTitle">📅 Googleカレンダー一括登録</h3>
          <button id="gcalModalClose" type="button" class="modal-close" aria-label="閉じる">×</button>
        </div>
        <div class="modal-body">
          <p class="section-note">登録済みのシフトをICSファイルに出力し、Googleカレンダーにインポートできます。</p>

          <div class="field-row">
            <label>対象期間</label>
            <div class="gcal-range-tabs" role="group" aria-label="対象期間の選択">
              <label class="gcal-range-tab">
                <input type="radio" name="gcalRange" value="month" checked />
                今表示月
              </label>
              <label class="gcal-range-tab">
                <input type="radio" name="gcalRange" value="custom" />
                期間指定
              </label>
              <label class="gcal-range-tab">
                <input type="radio" name="gcalRange" value="all" />
                全件
              </label>
            </div>
          </div>

          <div id="gcalCustomRange" class="field-row split" hidden>
            <div>
              <label for="gcalStartDate">開始日</label>
              <input id="gcalStartDate" type="date" />
            </div>
            <div>
              <label for="gcalEndDate">終了日</label>
              <input id="gcalEndDate" type="date" />
            </div>
          </div>

          <div class="field-row">
            <label for="gcalStatusFilter">シフトステータスで絞り込み</label>
            <select id="gcalStatusFilter">
              <option value="all">全ステータス</option>
              <option value="planned">予定</option>
              <option value="confirmed">確定</option>
              <option value="attended">出勤済</option>
              <option value="absent">欠勤</option>
            </select>
          </div>

          <div class="field-row">
            <label for="gcalMasterFilter">勤務先で絞り込み</label>
            <select id="gcalMasterFilter">
              <option value="all">全勤務先</option>
            </select>
          </div>

          <div id="gcalPreview" class="gcal-preview">
            <p class="gcal-preview-count">0件のシフトが対象です</p>
          </div>
        </div>
        <div class="modal-footer">
          <button id="gcalDownloadIcs" type="button" class="primary">ICSファイルをダウンロード</button>
          <button id="gcalOpenUrls" type="button">ポップアップで登録（少数向け）</button>
          <button id="gcalModalCancel" type="button">キャンセル</button>
        </div>
      </div>
    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="false"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./app.js"></script>
  </body>
</html>
